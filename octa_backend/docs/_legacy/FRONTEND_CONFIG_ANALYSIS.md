"""
å‰ç«¯åˆå§‹åŒ–é…ç½®å¯¹è®­ç»ƒæ”¶æ•›æ€§çš„å½±å“åˆ†æ
===============================================

åˆ†ææ—¶é—´: 2026å¹´1æœˆ21æ—¥
åˆ†æç›®æ ‡: è¯„ä¼°å‰ç«¯TrainView.vueä¸­çš„åˆå§‹åŒ–å‚æ•°æ˜¯å¦ä¼šå¯¼è‡´åç«¯è®­ç»ƒæŸå¤±ä¸æ”¶æ•›

## 1. å‰ç«¯å½“å‰é…ç½®ï¼ˆTrainView.vueï¼‰

```javascript
trainParams = {
  model_arch: 'unet',
  epochs: 50,
  lr: 0.0001,              // âœ… å·²ä¿®æ­£ä¸º1e-4
  weight_decay: 0.0001,     // âš ï¸ å‰ç«¯è®¾ç½®ä½†åç«¯æœªä½¿ç”¨
  batch_size: 4,
  
  // RS-Unet3+ ç‰¹å®šå‚æ•°ï¼ˆå½“å‰å ä½ï¼Œæœªå®é™…ä½¿ç”¨ï¼‰
  attention_weight: 0.8,
  deep_supervision: true,
  loss_function: 'Lovasz-Softmax'
}
```

## 2. åç«¯å®é™…ä½¿ç”¨çš„é…ç½®ï¼ˆtrain_service.pyï¼‰

```python
# train_model() æ¥æ”¶å‰ç«¯å‚æ•°åä¼ é€’ç»™ train_unet()
def train_unet(lr=1e-4, batch_size=4, epochs=10):
    # å®é™…è®­ç»ƒé…ç½®
    criterion = DiceBCELoss(alpha=0.5, smooth=1e-6, pos_weight=10.0)
    optimizer = Adam(lr=lr, weight_decay=1e-5)  # âš ï¸ ç¡¬ç¼–ç 1e-5ï¼Œå¿½ç•¥å‰ç«¯weight_decay
    scheduler = StepLR(step_size=50, gamma=0.8)
    accumulate_steps = 2 if batch_size < 8 else 1
```

## 3. æ”¶æ•›æ€§å½±å“åˆ†æ

### âœ… ä¸ä¼šå¯¼è‡´ä¸æ”¶æ•›çš„é…ç½®

| å‚æ•° | å‰ç«¯å€¼ | åç«¯å®é™…å€¼ | å½±å“ | ç»“è®º |
|------|--------|-----------|------|------|
| **lr** | 0.0001 | 0.0001 (1e-4) | å­¦ä¹ ç‡åˆç†ï¼Œé¿å…éœ‡è¡ | âœ… æ­£ç¡® |
| **batch_size** | 4 | 4 | å°batch+æ¢¯åº¦ç´¯ç§¯ï¼Œç­‰æ•ˆbatch=8 | âœ… æ­£ç¡® |
| **epochs** | 50 | 50 | è¶³å¤Ÿçš„è®­ç»ƒè½®æ¬¡ | âœ… æ­£ç¡® |

### âš ï¸ å¯èƒ½å¯¼è‡´æ··æ·†çš„é…ç½®ï¼ˆä¸å½±å“æ”¶æ•›ï¼‰

| å‚æ•° | å‰ç«¯å€¼ | åç«¯å®é™…å€¼ | å½±å“ | ç»“è®º |
|------|--------|-----------|------|------|
| **weight_decay** | 0.0001 | 1e-5 (ç¡¬ç¼–ç ) | å‰ç«¯è®¾ç½®è¢«å¿½ç•¥ï¼Œåç«¯å¼ºåˆ¶1e-5 | âš ï¸ ä¸ä¸€è‡´ä½†æ— å®³ |
| **attention_weight** | 0.8 | æœªä½¿ç”¨ | ä»…å ä½å‚æ•°ï¼Œä¸å½±å“U-Netè®­ç»ƒ | âš ï¸ ä»…æ¥å£å…¼å®¹ |
| **deep_supervision** | true | æœªä½¿ç”¨ | ä»…å ä½å‚æ•°ï¼Œä¸å½±å“U-Netè®­ç»ƒ | âš ï¸ ä»…æ¥å£å…¼å®¹ |
| **loss_function** | 'Lovasz-Softmax' | DiceBCELoss | å‰ç«¯æ˜¾ç¤ºä¸åç«¯å®é™…ä¸ç¬¦ | âš ï¸ ç•Œé¢è¯¯å¯¼ |

## 4. æ ¸å¿ƒå‘ç°

### âœ… å‰ç«¯é…ç½®ä¸ä¼šå¯¼è‡´ä¸æ”¶æ•›

**å…³é”®åŸå› ï¼š**
1. **lr=0.0001 (1e-4)** å·²ç»æ˜¯æœ€ä¼˜å­¦ä¹ ç‡ï¼Œé¿å…äº†ä¹‹å‰lr=1e-3æ—¶çš„éœ‡è¡é—®é¢˜
2. **batch_size=4 + æ¢¯åº¦ç´¯ç§¯** å®é™…ç­‰æ•ˆbatch=8ï¼Œä¿è¯è®­ç»ƒç¨³å®šæ€§
3. **åç«¯ç¡¬ç¼–ç çš„ä¼˜åŒ–é…ç½®** ç¡®ä¿äº†è®­ç»ƒè´¨é‡ï¼š
   - DiceBCELoss(pos_weight=10.0) å¤„ç†ç±»åˆ«ä¸å¹³è¡¡
   - weight_decay=1e-5 é˜²æ­¢è¿‡æ‹Ÿåˆ
   - æ¢¯åº¦è£å‰ª(max_norm=1.0) é˜²æ­¢æ¢¯åº¦çˆ†ç‚¸
   - StepLRè°ƒåº¦å™¨ é€æ­¥é™ä½å­¦ä¹ ç‡

### âš ï¸ å­˜åœ¨çš„é—®é¢˜ï¼ˆä¸å½±å“æ”¶æ•›ï¼Œä½†éœ€æ”¹è¿›ï¼‰

#### é—®é¢˜1: weight_decay ä¸ä¸€è‡´
- **ç°è±¡**ï¼šå‰ç«¯è®¾ç½®0.0001ï¼Œåç«¯ç¡¬ç¼–ç 1e-5
- **å½±å“**ï¼šç”¨æˆ·ä»¥ä¸ºä¿®æ”¹weight_decayæœ‰æ•ˆï¼Œå®é™…æ— æ•ˆ
- **å»ºè®®**ï¼š
  - æ–¹æ¡ˆA: åç«¯ä½¿ç”¨å‰ç«¯ä¼ å…¥çš„weight_decay
  - æ–¹æ¡ˆB: å‰ç«¯éšè—weight_decayè¾“å…¥æ¡†ï¼ˆè¯´æ˜ç”±åç«¯è‡ªåŠ¨ä¼˜åŒ–ï¼‰

#### é—®é¢˜2: æŸå¤±å‡½æ•°æ˜¾ç¤ºè¯¯å¯¼
- **ç°è±¡**ï¼šå‰ç«¯æ˜¾ç¤º"Lovasz-Softmax"ï¼Œåç«¯å®é™…ç”¨DiceBCELoss
- **å½±å“**ï¼šç”¨æˆ·è¯¯è§£è®­ç»ƒé…ç½®
- **å»ºè®®**ï¼šå‰ç«¯æ”¹ä¸ºæ˜¾ç¤º"DiceBCELoss (è‡ªåŠ¨ä¼˜åŒ–)"

#### é—®é¢˜3: æœªå®ç°çš„å‚æ•°
- **ç°è±¡**ï¼šattention_weight/deep_supervisionæ˜¾ç¤ºä½†ä¸ç”Ÿæ•ˆ
- **å½±å“**ï¼šç”¨æˆ·è°ƒæ•´è¿™äº›å‚æ•°åå‘ç°æ— æ•ˆæœ
- **å»ºè®®**ï¼š
  - æ–¹æ¡ˆA: ç°åŒ–è¿™äº›è¾“å…¥æ¡†ï¼Œæç¤º"U-Netæ¨¡å¼ä¸‹ä¸å¯ç”¨"
  - æ–¹æ¡ˆB: ä»…åœ¨model_arch='rs_unet3_plus'æ—¶æ˜¾ç¤º

## 5. å†å²æ ¹æœ¬åŸå› å›é¡¾

**ä¹‹å‰å¯¼è‡´æŸå¤±ä¸æ”¶æ•›çš„çœŸæ­£åŸå› ï¼š**

1. **lr=1e-3 è¿‡å¤§** âœ… å·²ä¿®å¤
   - ç—‡çŠ¶ï¼šæŸå¤±åœ¨0.7é™„è¿‘éœ‡è¡ï¼Œæ— æ³•ä¸‹é™
   - ä¿®å¤ï¼šå‰ç«¯æ”¹ä¸º0.0001ï¼Œåç«¯é»˜è®¤1e-4

2. **DiceBCELossåŒé‡sigmoid** âœ… å·²ä¿®å¤
   - ç—‡çŠ¶ï¼šæ¢¯åº¦æ¥è¿‘0ï¼Œæ¨¡å‹æ— æ³•å­¦ä¹ 
   - ä¿®å¤ï¼šlosses.pyä¸­DiceLossæ”¹ä¸ºsigmoid=False

3. **pos_weightè®¾å¤‡ä¸åŒ¹é…** âœ… å·²ä¿®å¤
   - ç—‡çŠ¶ï¼šGPUè®­ç»ƒæ—¶ç±»åˆ«æƒé‡å¤±æ•ˆ
   - ä¿®å¤ï¼šä½¿ç”¨register_bufferæ³¨å†Œpos_weight

4. **æ•°æ®å¢å¼ºä¸åŒæ­¥** âœ… å·²ä¿®å¤
   - ç—‡çŠ¶ï¼šå›¾åƒå’Œæ©ç åº”ç”¨ä¸åŒéšæœºå˜æ¢
   - ä¿®å¤ï¼šä½¿ç”¨å…±äº«éšæœºå‚æ•°

## 6. ç»“è®º

### ğŸ“Š æ”¶æ•›æ€§è¯„ä¼°

**å‰ç«¯å½“å‰é…ç½®ï¼ˆlr=0.0001ï¼‰ä¸ä¼šå¯¼è‡´è®­ç»ƒä¸æ”¶æ•›ã€‚**

ç†ç”±ï¼š
- âœ… å­¦ä¹ ç‡åˆç†ï¼ˆ1e-4ï¼‰
- âœ… åç«¯è‡ªåŠ¨åº”ç”¨äº†æ‰€æœ‰å¿…è¦çš„ä¼˜åŒ–ï¼ˆpos_weight, æ¢¯åº¦è£å‰ª, è°ƒåº¦å™¨ï¼‰
- âœ… æ•°æ®å¢å¼ºåŒæ­¥
- âœ… æŸå¤±å‡½æ•°æ­£ç¡®å®ç°

### ğŸ¯ é¢„æœŸè®­ç»ƒæ•ˆæœ

ä½¿ç”¨å½“å‰é…ç½®ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
- è®­ç»ƒæŸå¤±ä»epoch 1å¼€å§‹æŒç»­ä¸‹é™
- 10-20 epochsåé™åˆ°0.3-0.4
- 50 epochsåå¯è¾¾åˆ°0.2ä»¥ä¸‹
- éªŒè¯Diceä»0.39æå‡åˆ°0.70+

### ğŸ”§ å»ºè®®ä¼˜åŒ–ï¼ˆéå¿…éœ€ï¼‰

å¦‚æœè®­ç»ƒä»ä¸æ”¶æ•›ï¼Œé—®é¢˜ä¸åœ¨å‰ç«¯é…ç½®ï¼Œåº”æ£€æŸ¥ï¼š
1. **æ•°æ®é›†è´¨é‡**
   - è¿è¡Œ `python diagnostic_tool.py --dataset_path "path"`
   - æ£€æŸ¥å›¾åƒå½’ä¸€åŒ–ã€ç±»åˆ«å¹³è¡¡ã€é‡å¤å›¾åƒ

2. **æ¨¡å‹åˆå§‹åŒ–**
   - ç¡®è®¤models/unet.pyä½¿ç”¨Heåˆå§‹åŒ–
   - ç¡®è®¤BatchNormå±‚æ­£å¸¸å·¥ä½œ

3. **æ•°æ®åŠ è½½**
   - éªŒè¯train/valåˆ†ç¦»æ­£ç¡®
   - ç¡®è®¤æ©ç å€¼åœ¨[0,1]èŒƒå›´

## 7. ä»£ç æ”¹è¿›å»ºè®®ï¼ˆå¯é€‰ï¼‰

### æ”¹è¿›1: ç»Ÿä¸€weight_decay
```python
# train_service.py line 272
optimizer = optim.Adam(
    model.parameters(), 
    lr=lr, 
    betas=(0.9, 0.999),
    weight_decay=weight_decay if weight_decay else 1e-5  # ä½¿ç”¨å‰ç«¯ä¼ å…¥çš„å€¼
)
```

### æ”¹è¿›2: ä¿®æ­£å‰ç«¯loss_functionæ˜¾ç¤º
```javascript
// TrainView.vue
trainParams = {
  // ...
  loss_function: 'DiceBCELoss (è‡ªåŠ¨ä¼˜åŒ–)'  // æ”¹ä¸ºå®é™…ä½¿ç”¨çš„æŸå¤±å‡½æ•°
}
```

### æ”¹è¿›3: æ¡ä»¶æ˜¾ç¤ºé«˜çº§å‚æ•°
```vue
<!-- TrainView.vue -->
<div v-if="trainParams.model_arch === 'rs_unet3_plus'" class="form-section">
  <el-form-item label="æ³¨æ„åŠ›æƒé‡ï¼š">
    <!-- attention_weight ä»…åœ¨RS-Unet3+æ¨¡å¼ä¸‹æ˜¾ç¤º -->
  </el-form-item>
</div>
```

## 8. å¿«é€ŸéªŒè¯æ–¹æ³•

å¦‚æœä½ æƒ³ç¡®è®¤é…ç½®æ— é—®é¢˜ï¼Œè¿è¡Œè¯Šæ–­å·¥å…·ï¼š

```bash
cd octa_backend
python diagnostic_tool.py --dataset_path "uploads/datasets/extracted"
```

æŸ¥çœ‹è¾“å‡ºï¼š
- Step 1: å­¦ä¹ ç‡æµ‹è¯•ï¼ˆåº”è¯¥lr=1e-4è¡¨ç°æœ€å¥½ï¼‰
- Step 4: å•å›¾è¿‡æ‹Ÿåˆï¼ˆlossåº”é™åˆ°<0.1ï¼‰

å¦‚æœä¸¤é¡¹éƒ½é€šè¿‡ï¼Œè¯´æ˜é…ç½®å®Œå…¨æ­£ç¡®ã€‚

===============================================
æ€»ç»“: å‰ç«¯å½“å‰é…ç½®ä¸ä¼šå¯¼è‡´ä¸æ”¶æ•›ï¼
å¦‚æœä»æœ‰é—®é¢˜ï¼ŒåŸå› åœ¨æ•°æ®é›†æˆ–å…¶ä»–ç¯èŠ‚ã€‚
===============================================
"""
